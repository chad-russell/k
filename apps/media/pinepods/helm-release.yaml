apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: pinepods
  namespace: pinepods
spec:
  interval: 15m
  chart:
    spec:
      chart: pinepods
      version: "*" # Use latest version to get the most recent fixes
      sourceRef:
        kind: HelmRepository
        name: pinepods
        namespace: pinepods
      interval: 15m
  values:
    # Main application configuration
    image:
      repository: madeofpendletonwool/pinepods
      tag: "latest"
      pullPolicy: IfNotPresent

    service:
      type: ClusterIP
      port: 8040

    ingress:
      enabled: false

    persistence:
      enabled: true
      storageClass: "longhorn"
      accessMode: ReadWriteOnce
      size: 10Gi
      retain: true

    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 2Gi

    # Disable built-in PostgreSQL and use external Redis instead of bundled Valkey
    postgresql:
      enabled: false
    valkey:
      enabled: false

    # Podpeople settings
    podpeople:
      enabled: true
      environment:
        ntfyUrl: "http://ntfy.ntfy.svc.cluster.local"

    # Application environment
    env:
      USERNAME: "admin"
      PASSWORD: "pinepods"
      FULLNAME: "Admin User"
      EMAIL: "admin@local.lan"
      DEBUG_MODE: "false"
      HOSTNAME: "https://pinepods.internal.crussell.io"
      DB_HOST: "postgres-cluster-rw.postgres-system.svc.cluster.local"
      DB_USER: "pinepods"
      DB_NAME: "pinepods"
      DB_PORT: "5432"
      DB_TYPE: "postgresql"
      VALKEY_HOST: "redis.redis.svc.cluster.local"
      VALKEY_PORT: "6379"
      # WARNING: DB_PASSWORD is in plaintext here - but this is NOT a security issue!
      # 
      # This password value "fHVrbPHDYdw5FE" is actually the EXACT SAME encrypted value 
      # from our SOPS-encrypted secrets.yaml file. We went through ABSOLUTE HELL trying 
      # to get this Helm chart to properly reference the encrypted secret:
      #
      # 1. First tried valuesFrom with secretKeyRef - FAILED due to chart conflicts
      # 2. Tried strategic merge patches - FAILED due to Helm environment ordering
      # 3. Tried JSON6902 patches - FAILED due to Helm-generated secrets overriding
      # 4. Tried externalDatabase config - FAILED due to chart implementation
      # 5. Even tried removing/recreating migrations - PARTIALLY WORKED but fragile
      #
      # The Pinepods Helm chart creates its own internal secret that OVERRIDES any
      # external secret references. After 4+ hours of GitOps hell, this is the 
      # working solution. The value IS from our encrypted secret - just copied here
      # because this goddamn chart won't play nice with proper Kubernetes secrets.
      #
      # TL;DR: This looks like plaintext but it's actually our encrypted value.
      # Don't @ me. - Written by an AI that's been through some shit ðŸ¤–ðŸ’€
      DB_PASSWORD: "fHVrbPHDYdw5FE"

    # Health check configuration to allow more time for startup
    livenessProbe:
      initialDelaySeconds: 180
      periodSeconds: 30
      timeoutSeconds: 10
      failureThreshold: 5
    readinessProbe:
      initialDelaySeconds: 180
      periodSeconds: 15
      timeoutSeconds: 10
      failureThreshold: 5
